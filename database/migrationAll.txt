DELIMITER $$

DROP PROCEDURE IF EXISTS migrationAll$$

CREATE PROCEDURE migrationAll()

BEGIN 

	CREATE TABLE users (
	   id INT AUTO_INCREMENT PRIMARY KEY,
	   name VARCHAR(50) NOT NULL,
	   nik VARCHAR(25) NOT NULL UNIQUE,
	   password VARCHAR(255) NOT NULL,
	   role ENUM('user','worker', 'admin', 'supervisor', 'root') NOT NULL DEFAULT 'worker',
	   id_chat_telegram VARCHAR(255) NULL,
	   created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	   updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
	);

	CREATE TABLE systems (
		id INT AUTO_INCREMENT PRIMARY KEY,
		user_id INT NOT NULL,
		name VARCHAR(128) NOT NULL,
		status ENUM('listing','in progress','trial','golive') NOT NULL DEFAULT 'listing',
		dept VARCHAR(50) NOT NULL, 
		pic_name VARCHAR(50) NULL,
		pic_nik VARCHAR(25) NULL,
		created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
		updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		CONSTRAINT fk_user_systems FOREIGN KEY (user_id) REFERENCES users(id)
	);
	
	CREATE TABLE tickets (
		id INT AUTO_INCREMENT PRIMARY KEY,
		system_id INT NOT NULL,
		no_ticket VARCHAR(50) NOT NULL UNIQUE,
		category ENUM('system','bug','feature','meeting') NOT NULL,
		urls VARCHAR(255) NULL,
		priority ENUM('high','medium','low') NOT NULL DEFAULT 'low',
		status ENUM('waiting approval','approved','on progress','done','closed','reject'),
		description TEXT NOT NULL,
		deadline DATE NULL,
		requestor_name VARCHAR(50) NOT NULL,
		requestor_nik VARCHAR(25) NOT NULL,
		requested_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
		in_progress_name VARCHAR(50) NULL,
		in_progress_nik VARCHAR(25) NULL,
		in_progress_at TIMESTAMP NULL,
		done_name VARCHAR(50) NULL,
		done_nik VARCHAR(25) NULL,
		done_at TIMESTAMP NULL,
		closed_name VARCHAR(50) NULL,
		closed_nik VARCHAR(25) NULL,
		closed_at TIMESTAMP NULL,
		approve_name VARCHAR(50) NULL,
		approve_nik VARCHAR(25) NULL,
		approve_at TIMESTAMP NULL,
		reject_name VARCHAR(50) NULL,
		reject_nik VARCHAR(25) NULL,
		reject_at TIMESTAMP NULL,
		reject_reason TEXT NULL,
		date_meeting TIMESTAMP NULL,
		created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
		updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		CONSTRAINT fk_system_tickets FOREIGN KEY (system_id) REFERENCES systems(id)
	);
	
	CREATE TABLE documents (
		id INT AUTO_INCREMENT PRIMARY KEY,
		ticket_id INT NOT NULL,
		name_file VARCHAR(255) NOT NULL,
		created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
		updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		CONSTRAINT fk_ticket_documents FOREIGN KEY(ticket_id) REFERENCES tickets(id)
	);
	
	CREATE TABLE chats (
		id INT AUTO_INCREMENT PRIMARY KEY,
		ticket_id INT NOT NULL,
		user_id INT NOT NULL,
		is_read ENUM('y','n') DEFAULT 'n',
		is_read_user ENUM('y','n') DEFAULT 'n',
		message TEXT NOT NULL,
		created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
		updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		CONSTRAINT fk_ticket_chats FOREIGN KEY (ticket_id) REFERENCES tickets(id),
		CONSTRAINT fk_user_chats FOREIGN KEY (user_id) REFERENCES users(id)
	);

END $$

DELIMITER ;